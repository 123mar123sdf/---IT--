package com.example.myapplication;

import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;


import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.*;
import androidx.appcompat.app.AppCompatActivity;
import java.util.List;

/**
 * MainActivity.java — мозг главного экрана.
 * Аналогия: диспетчер в приёмной — принимает заявки,
 * управляет списком, направляет к нужному экрану.
 */
public class MainActivity extends AppCompatActivity {

    private EditText etLessonName;
    private Spinner spinnerDirection;
    private Button btnAdd;
    private ListView lvLessons;
    private TextView tvEmpty;
    private List<Lesson> lessonList;
    private LessonAdapter adapter;
    private static final int REQUEST_DETAIL = 100;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // Находим элементы на экране по ID («адресам»)
        etLessonName = findViewById(R.id.etLessonName);
        spinnerDirection = findViewById(R.id.spinnerDirection);
        btnAdd = findViewById(R.id.btnAdd);
        lvLessons = findViewById(R.id.lvLessons);
        tvEmpty = findViewById(R.id.tvEmpty);

        // Загружаем ранее сохранённые занятия из «блокнота»
        lessonList = StorageHelper.loadLessons(this);

        // Создаём адаптер и подключаем к списку
        adapter = new LessonAdapter(this, lessonList);
        lvLessons.setAdapter(adapter);
        updateEmptyView();

        // Кнопка «Добавить» — при нажатии вызываем addLesson()
        btnAdd.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) { addLesson(); }
        });

        // Нажатие на занятие в списке — открываем детали
        lvLessons.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                openDetail(position);
            }
        });
    }

    // Добавляет новое занятие
    private void addLesson() {
        String name = etLessonName.getText().toString().trim();
        if (name.isEmpty()) {
            Toast.makeText(this, R.string.error_empty_name, Toast.LENGTH_SHORT).show();
            return;
        }
        String direction = spinnerDirection.getSelectedItem().toString();
        Lesson newLesson = new Lesson(name, direction);
        lessonList.add(newLesson);
        adapter.notifyDataSetChanged();       // Обновляем экран
        StorageHelper.saveLessons(this, lessonList); // Сохраняем
        etLessonName.setText("");             // Очищаем поле
        updateEmptyView();
    }

    // Открывает экран деталей через Intent («записку»)
    private void openDetail(int position) {
        Intent intent = new Intent(this, DetailActivity.class);
        intent.putExtra("lesson_position", position);
        startActivityForResult(intent, REQUEST_DETAIL);
    }

    // Возврат с экрана деталей — перезагружаем данные
    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == REQUEST_DETAIL) {
            lessonList.clear();
            lessonList.addAll(StorageHelper.loadLessons(this));
            adapter.notifyDataSetChanged();
            updateEmptyView();
        }
    }

    // Показывает/скрывает надпись «Пока нет занятий»
    private void updateEmptyView() {
        tvEmpty.setVisibility(lessonList.isEmpty() ? View.VISIBLE : View.GONE);
        lvLessons.setVisibility(lessonList.isEmpty() ? View.GONE : View.VISIBLE);
    }
}
